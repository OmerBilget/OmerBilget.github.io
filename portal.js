//portal creates enemies 
class PORTAL{
    vertices=[];
    faces=[];
    arraybuffer=[];
    buffer;
    material=[];
    materialindex=[];
    materialid=[];
    program;
    angle;
    life;
    max_life;
    max_enemy_count;
    cooldown;
    cooldown_time;
    blue;
    yellow;
    green;
    enabled;
    constructor(translation,scale,blue,yellow,green){
        this.translation=translation;
        this.scale=scale;
        parseOBJ(portalOBJ,this,this.scale);
        parseMTL(portalMTL,this);
        this.arraybuffer=new Float32Array(createBufferArray(this));
        this.angle=0;
        this.life=200;
        this.max_life=200;
        this.max_enemy_count=4;
        this.cooldown_time=1000;
        this.cooldown=500;
        this.blue=blue;
        this.yellow=yellow;
        this.green=green;
        this.enabled=true;
    }

    spawn_enemy(id,enemy_list){
    



        let location=[this.translation[0],this.translation[1],this.translation[2]];
        let green_count=0;
        for(let i=0;i<active_length_enemy_list;i++){
            if(enemy_list[i].id==2){
                 green_count+=1;
            }
        }
        if(green_count>=2){ //if too much green is present spawn blue
            id=0;
        }
        if(id==0){

           enemy_list[active_length_enemy_list]=new BLUE_INSTANCE(this.blue.max_health,this.blue.max_health,location,[0,0,0],this.blue,0);
           active_length_enemy_list+=1;
        }else if(id==1){
           enemy_list[active_length_enemy_list]=new YELLOW_INSTANCE(this.yellow.max_health,this.yellow.max_health,location,[0,0,0],this.yellow,1);
           active_length_enemy_list+=1;
        }else if(id==2){
            enemy_list[active_length_enemy_list]=new GREEN_INSTANCE(this.green.max_health,this.green.max_health,location,[0,0,0],this.green,2);
            active_length_enemy_list+=1;
        }else{
            alert( "error no id found");
        }
        
       
    }

    check_status(enemy_list,deltatime){
        if(this.enabled==false){
            return;
        }
        if(active_length_enemy_list<this.max_enemy_count){ //if portal can spawn enemies
            if(active_length_enemy_list<3 && this.cooldown>this.max_life){
                this.cooldown=this.max_life;
            }
            if(this.cooldown>0){
                this.cooldown-=deltatime;
                if(this.cooldown>(this.cooldown_time-this.max_life)){
                    this.life-=deltatime;
                }else if(this.cooldown<this.max_life){
                    this.life+=deltatime;
                }
            }else{
                //spawn_enemy here
                this.cooldown=this.cooldown_time;
                var rand=Math.floor(Math.random()*3);
                this.spawn_enemy(rand,enemy_list);
                if(active_length_enemy_list==0){
                    this.cooldown=200*deltatime;
                }
                this.life=this.max_life;
            }
        }else{
            if(this.life>0){
                this.life-=deltatime;
            }
        }
    }

    createBufferData(gl){
        this.buffer=gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer);
        gl.bufferData(gl.ARRAY_BUFFER,this.arraybuffer,gl.STATIC_DRAW);
     }
    
}


function draw_portal(gl,portal,program,identitymatrix,w,v,p,world,view,projection,pos,color,center,ratio){
    gl.useProgram(program);
    gl.bindBuffer(gl.ARRAY_BUFFER,portal.buffer);
    
 
    mat4.translate(w,identitymatrix,portal.translation);
    vec3.add(player.camera_coordinates,player.coordinate,player.lookingto);
    glMatrix.mat4.lookAt(v,player.coordinate,player.camera_coordinates,direction_up);//camera 
    mat4.rotateY(w,w,portal.angle);
    portal.angle+=0.02;
    portal.angle%=Math.PI*2;
    
    gl.vertexAttribPointer(pos,3,gl.FLOAT,gl.FALSE,6*Float32Array.BYTES_PER_ELEMENT,0);
    gl.vertexAttribPointer(color,3,gl.FLOAT,gl.FALSE,6*Float32Array.BYTES_PER_ELEMENT,3*Float32Array.BYTES_PER_ELEMENT);
    gl.enableVertexAttribArray(pos);
    gl.enableVertexAttribArray(color);
    gl.uniformMatrix4fv(world,gl.FALSE,w);
    gl.uniformMatrix4fv(view,gl.FALSE,v);
    gl.uniformMatrix4fv(projection,gl.FALSE,p);
    gl.uniform3fv(center,portal.translation);
    gl.uniform1f(ratio,(portal.life/portal.max_life));
    gl.drawArrays(gl.TRIANGLES,0,portal.arraybuffer.length/6);
 }




 
var portalOBJ=
`v 1.264809 3.323588 2.292290
v 4.593302 3.323587 7.506870
v -0.585674 3.323588 2.177255
v -2.335245 3.323587 3.146276
v -1.387767 3.323587 8.311369
v -1.929283 3.323588 0.899666
v -3.892406 3.323588 0.517376
v -6.486655 3.323587 5.083094
v -2.137328 3.323588 -0.942679
v -3.395437 3.323588 -2.497402
v -8.317533 3.323587 -0.667409
v -1.112464 3.323588 -2.487727
v -1.076875 3.323588 -4.487410
v -6.023716 3.323588 -6.249417
v 0.665765 3.323588 -3.012531
v 1.978400 3.323588 -4.521501
v -0.678504 3.323588 -9.051046
v 2.365306 3.323588 -2.271532
v 4.340790 3.323588 -2.583724
v 5.217018 3.323589 -7.761382
v 3.190924 3.323588 -0.611449
v 4.904906 3.323588 0.419214
v 8.904269 3.323588 -2.983873
v 2.756304 3.323588 1.190945
v 3.406792 3.323588 3.082205
v 8.657945 3.323588 3.046031
v 0.547433 3.323587 4.159206
v 4.369635 3.323588 3.135666
v 4.367965 3.323587 5.446052
v 12.787424 3.315193 5.848180
v 5.676850 3.323588 -0.158735
v 7.160658 3.323588 1.612196
v 13.868820 3.315194 -3.491681
v 4.560635 3.323588 -3.522655
v 6.835630 3.323588 -3.119817
v 8.693672 3.315194 -11.341537
v 1.543278 3.323588 -5.382079
v 3.544965 3.323588 -6.535824
v -0.316513 3.315194 -14.028355
v -1.963366 3.323588 -4.866959
v -1.171599 3.323588 -7.037439
v -8.945767 3.315194 -10.294941
v -4.318498 3.323588 -2.218328
v -5.107127 3.323588 -4.389950
v -13.156368 3.315193 -1.888202
v -4.420127 3.323587 1.324491
v -6.420144 3.323587 0.167853
v -10.978128 3.315192 7.258255
v -2.220699 3.323587 4.103774
v -4.496274 3.323587 4.503324
v -3.430269 3.315192 12.864704
v 1.250649 3.323587 4.819063
v -0.235716 3.323587 6.587847
v 5.955482 3.315192 12.307819
v 7.273512 3.323588 3.334990
v 10.745461 3.323588 5.103277
v 17.225302 3.315193 3.084273
v 8.029471 3.323588 -1.872622
v 11.825771 3.323588 -2.749761
v 15.491827 3.315194 -8.461569
v 5.261182 3.323588 -6.347805
v 7.605504 3.323589 -9.459948
v 6.742384 3.315195 -16.191940
v 0.263957 3.323588 -7.996572
v 0.059364 3.323589 -11.887510
v -4.929065 3.315194 -16.489716
v -4.623946 3.323588 -6.047445
v -7.281721 3.323588 -8.896568
v -14.061321 3.315193 -9.215561
v -7.115423 3.323588 -1.412445
v -10.982779 3.323588 -1.886615
v -16.381298 3.315192 2.226866
v -6.044684 3.323587 3.739663
v -9.312041 3.323587 5.862316
v -10.803452 3.315192 12.483526
v -1.912740 3.323587 6.998148
v -3.051265 3.323587 10.724411
v 0.062281 3.315192 16.755213
v 3.347028 3.323587 6.838329
v 4.870062 3.323587 10.424643
v 11.131701 3.315192 13.043156
v 19.960045 4.227311 -7.736080
v 14.196539 3.220871 2.558038
v 8.196725 3.220871 2.763997
v 10.630625 4.227312 -18.508829
v 12.833059 3.220872 -6.918481
v 8.369531 3.220872 -2.903867
v -3.440833 4.227312 -20.763662
v 5.696850 3.220873 -13.301115
v 4.858444 3.220872 -7.356598
v -15.669193 4.227311 -13.445370
v -3.872497 3.220872 -13.602930
v -0.693426 3.220872 -8.510414
v -20.331852 4.227309 0.021250
v -11.396737 3.220871 -7.682685
v -5.687924 3.220871 -5.825356
v -15.246784 4.227308 13.334116
v -13.354691 3.220871 1.689078
v -7.787734 3.220871 -0.557970
v -2.793689 4.227308 20.263092
v -8.830076 3.220870 10.126577
v -6.010190 3.220871 4.826720
v 11.199655 4.227309 17.565573
v 0.059685 3.220870 13.681246
v -1.187146 3.220870 7.808797
v 20.184671 4.227310 6.503935
v 9.154379 3.220871 10.689579
v 4.424320 3.220871 6.992716
v 0.117541 3.939917 1.833055
v 1.354144 3.939917 7.894534
v -1.568545 3.939917 1.061930
v -3.549271 3.939917 1.338920
v -4.517495 3.939917 6.500164
v -2.364491 3.939917 -0.612581
v -4.059862 3.939917 -1.673581
v -8.119149 3.939917 1.657799
v -1.897867 3.939918 -2.406956
v -2.514599 3.939918 -4.309492
v -7.765562 3.939917 -4.366765
v -0.387010 3.939918 -3.481587
v 0.363473 3.939918 -5.335441
v -3.622185 3.939918 -8.754570
v 1.461133 3.939918 -3.333641
v 3.227671 3.939918 -4.271375
v 2.372254 3.939918 -9.452511
v 2.781795 3.939918 -2.032345
v 4.737805 3.939918 -1.615182
v 7.412888 3.939918 -6.134014
v 2.957023 3.939917 -0.186589
v 4.187266 3.939917 1.390275
v 9.141148 3.939918 -0.351840
v 1.904827 3.939917 1.339977
v 1.833659 3.939917 3.338710
v 6.748363 3.939917 5.188467
v -1.221738 3.939917 3.318428
v 2.713256 3.939917 3.733973
v 1.882991 3.939917 5.890021
v 9.597961 3.931522 9.285347
v 5.115148 3.939917 1.127671
v 5.865008 3.939917 3.312984
v 13.957491 3.931523 0.954865
v 5.279804 3.939918 -2.412779
v 7.258922 3.939918 -1.220734
v 11.942354 3.931524 -8.228905
v 3.130181 3.939918 -5.230760
v 5.412505 3.939918 -5.589753
v 4.495456 3.931524 -13.968775
v -0.327889 3.939918 -6.007707
v 1.189716 3.939918 -7.749762
v -4.898715 3.931524 -13.578999
v -3.476337 3.939918 -4.380079
v -3.433555 3.939918 -6.690068
v -11.844526 3.931523 -7.241954
v -4.841969 3.939917 -1.109460
v -6.294028 3.939917 -2.906514
v -13.091952 3.931522 2.077184
v -3.785789 3.939917 2.273790
v -6.053256 3.939917 1.830532
v -8.057309 3.931522 10.017891
v -0.801998 3.939917 4.186611
v -2.823898 3.939917 5.304555
v 0.903640 3.931522 12.864614
v 5.352408 3.939917 4.961618
v 7.959063 3.939917 7.857584
v 14.731911 3.931522 8.297167
v 7.925970 3.939918 0.371686
v 11.784273 3.939918 0.914600
v 17.255136 3.931524 -3.102163
v 6.947081 3.939918 -4.798659
v 10.251692 3.939918 -6.862833
v 11.860689 3.931524 -13.456455
v 2.873775 3.939918 -8.130156
v 4.078428 3.939919 -11.835566
v 1.072693 3.931524 -17.920818
v -2.388003 3.939918 -8.063957
v -3.846978 3.939918 -11.676804
v -10.061029 3.931524 -14.406328
v -6.376208 3.939918 -4.631043
v -9.816141 3.939918 -6.460833
v -16.330887 3.931523 -4.557455
v -7.224716 3.939917 0.562292
v -11.036024 3.939917 1.371738
v -14.803139 3.931522 7.017408
v -4.536499 3.939917 5.086027
v -6.935829 3.939916 8.155962
v -6.192638 3.931521 14.902248
v 0.430596 3.939917 6.823456
v 0.565919 3.939916 10.717422
v 5.471667 3.931522 15.407665
v 21.165804 4.843640 -0.822255
v 12.093444 3.837201 6.719570
v 6.418996 3.837201 4.759765
v 16.321238 4.843641 -14.224508
v 14.219803 3.837202 -2.615422
v 8.613296 3.837201 -0.468963
v 3.994907 4.843641 -21.376556
v 9.847823 3.837202 -11.133009
v 6.932983 3.837202 -5.884782
v -10.044731 4.843641 -18.931398
v 1.023501 3.837202 -14.847147
v 2.164407 3.837202 -8.953207
v -19.227434 4.843639 -8.033318
v -8.123577 3.837202 -12.019701
v -3.460842 3.837201 -8.238283
v -19.255899 4.843638 6.217629
v -13.312778 3.837201 -3.973850
v -7.310271 3.837201 -4.074576
v -10.116798 4.843637 17.152306
v -12.115668 3.837200 5.525121
v -7.582431 3.837200 1.589386
v 3.912963 4.843638 19.653522
v -5.092468 3.837200 12.031900
v -4.149958 3.837200 6.102995
v 16.267767 4.843639 12.550766
v 4.470118 3.837200 12.501459
v 1.380827 3.837200 7.353981
v -7.668931 4.207217 8.006979
v -11.501850 4.207218 0.786383
v -9.796728 4.207219 -7.208667
v -3.351406 4.207219 -12.237200
v 4.818272 4.207220 -11.946308
v 10.889627 4.207219 -6.472102
v 12.021804 4.207219 1.623976
v 7.685045 4.207218 8.553679
v -0.091432 4.207217 11.074524
usemtl Material.001
s off
f 2/1/1 27/2/1 1/3/1
f 5/4/1 4/5/1 3/6/1
f 8/7/1 7/8/1 6/9/1
f 11/10/1 10/11/1 9/12/1
f 14/13/1 13/14/1 12/15/1
f 17/16/1 16/17/1 15/18/1
f 20/19/1 19/20/1 18/21/1
f 23/22/1 22/23/1 21/24/1
f 26/25/1 25/26/1 24/27/1
f 110/28/1 135/29/1 109/30/1
f 113/31/1 112/32/1 111/33/1
f 116/34/1 115/35/1 114/36/1
f 119/37/1 118/38/1 117/39/1
f 122/40/1 121/41/1 120/42/1
f 125/43/1 124/44/1 123/45/1
f 128/46/1 127/47/1 126/48/1
f 131/49/1 130/50/1 129/51/1
f 134/52/1 133/53/1 132/54/1
usemtl Material.002
f 30/55/2 29/56/2 28/57/2
f 33/58/3 32/59/3 31/60/3
f 36/61/4 35/62/4 34/63/4
f 39/64/5 38/65/5 37/66/5
f 42/67/6 41/68/6 40/69/6
f 45/70/7 44/71/7 43/72/7
f 48/73/8 47/74/8 46/75/8
f 51/76/9 50/77/9 49/78/9
f 54/79/10 53/80/10 52/81/10
f 138/82/11 137/83/11 136/84/11
f 141/85/12 140/86/12 139/87/12
f 144/88/13 143/89/13 142/90/13
f 147/91/14 146/92/14 145/93/14
f 150/94/15 149/95/15 148/96/15
f 153/97/16 152/98/16 151/99/16
f 156/100/17 155/101/17 154/102/17
f 159/103/18 158/104/18 157/105/18
f 162/106/19 161/107/19 160/108/19
usemtl Material.005
f 57/109/20 56/110/20 55/111/20
f 60/112/21 59/113/21 58/114/21
f 63/115/22 62/116/22 61/117/22
f 66/118/23 65/119/23 64/120/23
f 69/121/24 68/122/24 67/123/24
f 72/124/25 71/125/25 70/126/25
f 75/127/26 74/128/26 73/129/26
f 78/130/27 77/131/27 76/132/27
f 81/133/28 80/134/28 79/135/28
f 165/136/29 164/137/29 163/138/29
f 168/139/30 167/140/30 166/141/30
f 171/142/31 170/143/31 169/144/31
f 174/145/32 173/146/32 172/147/32
f 177/148/33 176/149/33 175/150/33
f 180/151/34 179/152/34 178/153/34
f 183/154/35 182/155/35 181/156/35
f 186/157/36 185/158/36 184/159/36
f 189/160/37 188/161/37 187/162/37
usemtl Material.006
f 82/163/38 83/164/38 84/165/38
f 85/166/39 86/167/39 87/168/39
f 88/169/40 89/170/40 90/171/40
f 91/172/41 92/173/41 93/174/41
f 94/175/42 95/176/42 96/177/42
f 97/178/43 98/179/43 99/180/43
f 100/181/44 101/182/44 102/183/44
f 103/184/45 104/185/45 105/186/45
f 106/187/46 107/188/46 108/189/46
f 190/190/47 191/191/47 192/192/47
f 193/193/48 194/194/48 195/195/48
f 196/196/49 197/197/49 198/198/49
f 199/199/50 200/200/50 201/201/50
f 202/202/51 203/203/51 204/204/51
f 205/205/52 206/206/52 207/207/52
f 208/208/53 209/209/53 210/210/53
f 211/211/54 212/212/54 213/213/54
f 214/214/55 215/215/55 216/216/55
usemtl Material.007
f 225/217/1 217/218/1 218/219/1
f 219/220/1 220/221/1 218/219/1
f 221/222/1 222/223/1 223/224/1
f 220/221/1 225/217/1 218/219/1
f 223/224/1 224/225/1 220/221/1
f 220/221/1 221/222/1 223/224/1
f 220/221/1 224/225/1 225/217/1`;

var portalMTL=
`newmtl Material.001
Kd 0.001890 0.058510 1.000000
newmtl Material.002
Kd 0.003062 0.249079 1.000000
newmtl Material.005
Kd 0.000000 0.462474 1.000000
newmtl Material.006
Kd 0.000000 1.000000 0.797886
newmtl Material.007
Kd 0.052085 0.000000 1.000000`;